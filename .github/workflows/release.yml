name: Release

on:
  workflow_dispatch:
    inputs:
      force_release:
        description: >-
          Resets the master branch to target branch. Use when fast forward merge fails due to
          divergent histories. Acknowledge that unmerged changes from the other branch will be
          abandoned (but not deleted).
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-22.04
    steps:
      - name: Verify branch
        if: github.ref_name != 'dev' && github.ref_name != 'hotfix'
        run: |
          echo "::error::This workflow can only be run from dev or hotfix branches"
          exit 1

      - name: Check workflow status
        uses: actions/github-script@v7
        with:
          script: |
            const since = new Date(Date.now() - 3600 * 1000).toISOString(); // 1 hour ago
            const { data } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              created: `>=${since}`,
            });

            // "release.yml" is checked using the concurrency group at the top of this file
            const workflows = [
              '.github/workflows/merge-to-dev-or-hotfix.yml',
              '.github/workflows/tag-push.yml',
            ];

            const terminalStatuses = [
              'completed',
              'success',
              'failure',
              'cancelled',
              'timed_out',
              'skipped',
              'neutral',
              'stale',
            ];

            const running = data.workflow_runs
              .filter(run => !terminalStatuses.includes(run.status))
              .filter(run => workflows.some(w => run.path.startsWith(w)))
              .map(r => `${r.name} (${r.html_url})`);

            if (running.length > 0) {
              const msg = `Workflows currently running:\n${running.join('\n')}`;
              core.setFailed(`${msg}\nPlease retry after they complete.`);
            }

  prepare:
    needs: checks
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.find-tags.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Merge to master (local only)
        env:
          OTHER_BRANCH: ${{ github.ref_name == 'dev' && 'hotfix' || 'dev' }}
        run: |
          git fetch origin ${{ github.ref_name }} --tags
          if git merge origin/${{ github.ref_name }} --ff-only; then
            echo "Fast forward to master branch succeeded"
          elif [[ "${{ inputs.force_release }}" == "true" ]]; then
            echo "::warning::Forcefully resetting master to ${{ github.ref_name }}"
            git reset --hard origin/${{ github.ref_name }}
          else
            echo "::error::Fast forward to master branch failed due to divergent histories."
            echo "::error::Set force_release=true to abandon unmerged changes from ${OTHER_BRANCH}."
            exit 1
          fi

      - name: Find tags to release
        id: find-tags
        run: |
          # Tags on source but not master (remote), sorted descending; first per app is latest
          RELEASE_TAGS=$(
            git tag \
              --merged origin/${{ github.ref_name }} \
              --no-merged origin/master \
              --sort=-version:refname \
              | grep '@' \
              | awk -F'@' '!seen[$1]++'
          )

          if [[ -z "$RELEASE_TAGS" ]]; then
            echo "::error::No unreleased tags found on ${{ github.ref_name }}. Nothing to release."
            exit 1
          fi

          # Build JSON array for matrix
          JSON="[]"
          for TAG in $RELEASE_TAGS; do
            APP="${TAG%%@*}"
            VERSION="${TAG#*@}"
            SHA=$(git rev-parse --short "${TAG}^{commit}")
            IMAGE_TAG="${VERSION}-${SHA}"

            JSON=$(echo "$JSON" | jq -c \
              --arg app "$APP" \
              --arg tag "$TAG" \
              --arg version "$VERSION" \
              --arg image_tag "$IMAGE_TAG" \
              '. + [{app: $app, tag: $tag, version: $version, image_tag: $image_tag}]')
          done

          echo "matrix=${JSON}" >> $GITHUB_OUTPUT
          echo "Found releases: ${JSON}"

  release-app:
    needs: prepare
    runs-on: ubuntu-22.04
    environment: production
    strategy:
      fail-fast: false
      matrix:
        release: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .

      - name: Create deployer app token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PK }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag Docker image as latest
        env:
          APP: ${{ matrix.release.app }}
          IMAGE_TAG: ${{ matrix.release.image_tag }}
        run: |
          IMAGE=$(echo "ghcr.io/nexusmutual/${APP}" | tr '[:upper:]' '[:lower:]')
          docker pull "${IMAGE}:${IMAGE_TAG}"
          docker tag "${IMAGE}:${IMAGE_TAG}" "${IMAGE}:latest"
          docker push "${IMAGE}:latest"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          TAG: ${{ matrix.release.tag }}
          APP: ${{ matrix.release.app }}
          VERSION: ${{ matrix.release.version }}
        run: |
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "${APP} v${VERSION}" --generate-notes
          fi

  finalize:
    needs: [prepare, release-app]
    runs-on: ubuntu-22.04
    environment: production
    steps:
      - name: Create deployer app token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOYER_APP_ID }}
          private-key: ${{ secrets.DEPLOYER_APP_PK }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: master
          fetch-depth: 0

      - name: Merge and push branches
        run: |
          git fetch origin ${{ github.ref_name }}

          # merge was validated in prepare job, this should succeed
          if [[ "${{ inputs.force_release }}" == "true" ]]; then
            git reset --hard origin/${{ github.ref_name }}
            git push --force origin master
          else
            git merge origin/${{ github.ref_name }} --ff-only
            git push origin master
          fi

          # update hotfix branch
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            git push --force origin master:hotfix
          fi
